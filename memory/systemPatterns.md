# System patterns

- **Parsing:** LALRPOP grammar in `crates/snaq-lite-lang/src/expr.lalrpop`; generated parser wired via `lalrpop_mod!(...)` in `parser.rs`. Build script `build.rs` runs `lalrpop::process_src()`. Float literals use conventional syntax; fallible actions (=>?) so invalid/overflow yields a parse error. Precedence: Expr (+, -) ← Term (*, /, per) ← Factor (literal, parentheses). Multiplication can be implicit only when the RHS is a number or parenthesized expression (e.g. `10 20` → 10*20, `2 (3+4)` → 14); `10 m` stays a single quantity literal (Ident excluded from implicit-mul RHS to avoid ambiguity). Division can be written as `/` or `per` (e.g. `3 kilometers per hour`).
- **IR:** `ExprDef` has parse-time variants `LitScalar`, `LitWithUnit`, `LitUnit` and resolved `Lit(Quantity)`; binary `Add`, `Sub`, `Mul`, `Div`. Two-step flow: parse → resolve (with unit registry) → `ExprDef` with only `Lit(Quantity)` for literals. `ExprData` / evaluation use `Lit(Quantity)`; `value()` returns `Result<Quantity, RunError>`.
- **Numbers and quantities:** Numeric values are `SnaqNumber` (value + variance). Variance propagates through arithmetic (Add/Sub: sum of variances; Mul/Div: standard propagation; scale by f64: variance × factor²). Literals get variance from f64 precision via `SnaqNumber::from_literal`. `Quantity` holds `number: SnaqNumber` and unit; `new(f64, unit)` / `from_scalar(f64)` use `from_literal`; results of arithmetic use `with_number(SnaqNumber, unit)`.
- **Units:** Default registry (`default_si_registry`) provides all 7 SI base units (m, kg, s, A, K, mol, cd) and all SI derived units with special names (J, C, V, F, ohm, S, Wb, T, H, Hz, N, Pa, W, lm, lx, Bq, Gy, Sv, kat), plus km, g, hour, minute, second, seconds, mile, au, parsec, light_year, joule, eV, celsius. Long-form aliases for base/derived units (ampere, kelvin, mole, candela, gram, volt, coulomb, etc.) via `add_derived_alias`. Prefix resolution via `get_unit_with_prefix` (e.g. km, mm). Quantity has `full_simplify` and `full_simplify_with_registry`.
- **Errors:** LALRPOP `ParseError` is mapped to `crate::error::ParseError` in the parser wrapper. Generated code has targeted `#[allow(...)]` for Clippy.
